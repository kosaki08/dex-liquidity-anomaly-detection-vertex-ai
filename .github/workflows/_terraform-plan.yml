# ãƒ—ãƒ©ãƒ³å®Ÿè¡Œç”¨
name: "_terraform-plan"

on:
  workflow_call:
    inputs:
      workspace:
        required: true
        type: string
      environment:
        required: true
        type: string
    secrets:
      PROJECT_ID:
        required: true
      PROJECT_NUMBER:
        required: true

jobs:
  plan:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    concurrency:
      group: terraform-${{ inputs.workspace }}-plan # åŒæ™‚å®Ÿè¡Œé˜²æ­¢
      cancel-in-progress: true # å¤ã„ãƒ—ãƒ©ãƒ³ã®ã¿ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    steps:
      # 1) ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) GCP èªè¨¼
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/gh-pool/providers/gh-provider
          service_account: tf-apply-${{ inputs.workspace }}@${{ secrets.PROJECT_ID }}.iam.gserviceaccount.com
          project_id: ${{ secrets.PROJECT_ID }}

      # 3) Terraform ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: 1.8.0

      # 4) Terraform åˆæœŸåŒ–
      - name: Initialize Terraform
        working-directory: terraform
        run: |
          terraform init \
            -backend-config=envs/${{ inputs.workspace }}/backend.conf \
            -input=false \
            -reconfigure

      # 5) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹é¸æŠ
      - name: Select workspace
        working-directory: terraform
        run: terraform workspace select ${{ inputs.workspace }} || terraform workspace new ${{ inputs.workspace }}

      # 6) Terraform ã®æ¤œè¨¼
      - name: Validate Terraform
        working-directory: terraform
        run: terraform validate

      # 7) Terraform ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: Format Check
        working-directory: terraform
        run: terraform fmt -check

      # 8) TFLint ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.51.1

      # 9) TFLint ã®åˆæœŸåŒ–
      - name: Init TFLint
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ github.token }}

      # 10) TFLint ã®å®Ÿè¡Œ
      - name: Run TFLint
        run: tflint --chdir terraform

      # 11) Trivy IaC ã‚¹ã‚­ãƒ£ãƒ³
      - name: Run Trivy IaC scanner
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: config
          scan-ref: ./terraform
          severity: HIGH,CRITICAL
          output: trivy-scan-result.txt
          exit-code: "0"

      # 12) Trivy çµæœã‚³ãƒ¡ãƒ³ãƒˆ (PR ã®ã¨ãã ã‘)
      - name: Comment Trivy scan result to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let body = fs.readFileSync('trivy-scan-result.txt', 'utf8').trim();

            if (!body) {
              body = 'Trivy scan: æ¤œå‡ºãªã—ğŸ‰';
            }

            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body,
            });

      # 12) Terraform Plan ã®å®Ÿè¡Œ
      - name: Terraform Plan
        id: plan
        working-directory: terraform
        run: |
          terraform plan \
            -var-file=envs/${{ inputs.workspace }}/terraform.tfvars \
            -var "project_id=${{ secrets.PROJECT_ID }}" \
            -var "env_suffix=${{ inputs.workspace }}" \
            -lock-timeout=300s \
            -no-color \
            -detailed-exitcode \
            -out=tfplan || TF_EXIT=$?

      # 13) PR ã¸ Plan ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment plan to PR
        if: github.event_name == 'pull_request'
        uses: borchero/terraform-plan-comment@v2
        with:
          token: ${{ github.token }}
          planfile: tfplan
          working-directory: terraform
          header: "Terraform Plan (${{ inputs.workspace }})"
          skip-empty: true # å¤‰æ›´ãªã—ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã—ãªã„
